<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>AI é¡§å•</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Roboto, "Helvetica Neue", sans-serif;
  background: #f5f7fa;
  color: #1a1a1a;
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Header - å°ˆæ¥­é¢¨æ ¼ */
header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
  z-index: 100;
  position: relative;
  overflow: hidden;
}

header::before {
  content: "";
  position: absolute;
  inset: 0;
  background-image:
    radial-gradient(circle at 10% 20%, rgba(255,255,255,0.18), transparent 35%),
    radial-gradient(circle at 90% 10%, rgba(99, 179, 237, 0.25), transparent 40%),
    linear-gradient(120deg, rgba(255,255,255,0.08), transparent 40%),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='360' height='120' viewBox='0 0 360 120'%3E%3Cg fill='none' stroke='rgba(255,255,255,0.18)' stroke-width='1'%3E%3Cpath d='M0 20 H360'/%3E%3Cpath d='M0 60 H360'/%3E%3Cpath d='M0 100 H360'/%3E%3Cpath d='M40 0 V120'/%3E%3Cpath d='M120 0 V120'/%3E%3Cpath d='M200 0 V120'/%3E%3Cpath d='M280 0 V120'/%3E%3C/g%3E%3Cg fill='rgba(125,211,252,0.35)'%3E%3Ccircle cx='40' cy='20' r='3'/%3E%3Ccircle cx='200' cy='60' r='3'/%3E%3Ccircle cx='280' cy='100' r='3'/%3E%3C/g%3E%3C/svg%3E");
  opacity: 0.9;
  pointer-events: none;
}

.header-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.header-left h1 {
  font-size: 18px;
  font-weight: 600;
  color: white;
  display: flex;
  align-items: center;
  gap: 8px;
  text-shadow:
    0 1px 0 rgba(0,0,0,0.35),
    0 2px 0 rgba(0,0,0,0.25),
    0 6px 12px rgba(0,0,0,0.35);
}

.header-left h1::before {
  content: "";
  width: 22px;
  height: 22px;
  display: inline-block;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='44' height='44' viewBox='0 0 44 44'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%23a5f3fc'/%3E%3Cstop offset='1' stop-color='%2360a5fa'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cg fill='none' stroke='url(%23g)' stroke-width='2'%3E%3Crect x='6' y='10' width='32' height='26' rx='8'/%3E%3Cpath d='M14 10V6h16v4'/%3E%3Ccircle cx='16' cy='22' r='3'/%3E%3Ccircle cx='28' cy='22' r='3'/%3E%3Cpath d='M14 30h16'/%3E%3Cpath d='M6 20h-3M41 20h-3M6 26h-3M41 26h-3'/%3E%3C/g%3E%3C/svg%3E");
  background-size: contain;
  background-repeat: no-repeat;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,0.35));
}

.header-subtitle {
  font-size: 11px;
  color: rgba(255,255,255,0.8);
  letter-spacing: 0.5px;
  text-shadow:
    0 1px 0 rgba(0,0,0,0.3),
    0 4px 10px rgba(0,0,0,0.25);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.model-info {
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(10px);
  padding: 5px 14px;
  border-radius: 16px;
  font-size: 11px;
  color: white;
  font-weight: 500;
  border: 1px solid rgba(255,255,255,0.3);
}

.header-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Chat Container - å°ˆæ¥­é¢¨æ ¼ */
#log {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: linear-gradient(to bottom, #f5f7fa 0%, #e8ecf1 100%);
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#log::-webkit-scrollbar {
  width: 6px;
}

#log::-webkit-scrollbar-track {
  background: transparent;
}

#log::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 3px;
}

#log::-webkit-scrollbar-thumb:hover {
  background: #999;
}

/* Message Bubbles - LINE é¢¨æ ¼ */
.message-container {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 4px;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-container.user {
  flex-direction: row-reverse;
}

/* Avatar - åœ“å½¢ */
.avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 600;
  position: relative;
}

.avatar.user {
  background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  color: white;
  box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
}

.avatar.assistant {
  background: transparent;
  color: white;
  box-shadow: none;
}

.avatar-3d {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  position: relative;
  transform-style: preserve-3d;
  animation: avatarFloat 3.2s ease-in-out infinite;
}

.avatar-3d::before {
  content: "";
  position: absolute;
  inset: -6px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(80, 164, 255, 0.35), transparent 65%);
  filter: blur(2px);
  opacity: 0.9;
}

.avatar-core {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #7dd3fc, #2563eb 65%, #1e3a8a 100%);
  box-shadow: 0 10px 18px rgba(37, 99, 235, 0.35);
}

.avatar-ring {
  position: absolute;
  inset: -4px;
  border-radius: 50%;
  border: 1px solid rgba(125, 211, 252, 0.6);
  box-shadow: 0 0 10px rgba(56, 189, 248, 0.6);
  animation: avatarPulse 2.4s ease-in-out infinite;
}

.avatar-face {
  position: absolute;
  inset: 10px;
  border-radius: 50%;
  background: rgba(15, 23, 42, 0.25);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  backdrop-filter: blur(3px);
}

.avatar-eye {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.9);
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.8);
  animation: avatarBlink 5.5s ease-in-out infinite;
}

.avatar-mouth {
  width: 12px;
  height: 4px;
  border-radius: 4px;
  background: rgba(255, 255, 255, 0.8);
  transition: transform 0.2s ease, height 0.2s ease;
}

.avatar-user-3d .avatar-core {
  background: radial-gradient(circle at 30% 30%, #c4b5fd, #7c3aed 65%, #4c1d95 100%);
  box-shadow: 0 10px 18px rgba(124, 58, 237, 0.35);
}

.avatar-user-3d .avatar-face {
  background: rgba(15, 23, 42, 0.15);
  color: #ffffff;
  font-size: 12px;
  font-weight: 600;
}

.avatar-user-3d .avatar-face::before {
  content: "ä½ ";
}

.header-avatar .avatar-3d {
  width: 36px;
  height: 36px;
}

.avatar-speaking .avatar-ring {
  animation: avatarPulse 1.1s ease-in-out infinite;
}

.avatar-speaking .avatar-mouth {
  height: 6px;
  transform: translateY(-1px);
}

@keyframes avatarFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-2px); }
}

@keyframes avatarPulse {
  0%, 100% { transform: scale(1); opacity: 0.7; }
  50% { transform: scale(1.08); opacity: 1; }
}

@keyframes avatarBlink {
  0%, 92%, 100% { transform: scaleY(1); }
  95% { transform: scaleY(0.1); }
}

/* Message Bubble */
.message-bubble {
  max-width: 100%;
  padding: 10px 14px;
  border-radius: 18px;
  line-height: 1.6;
  font-size: 15px;
  word-wrap: break-word;
  word-break: normal;
  overflow-wrap: break-word;
  position: relative;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  white-space: pre-wrap;
  display: block;
}

.message-container.user .message-bubble {
  background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  color: white;
  border-bottom-right-radius: 4px;
  box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
}

.message-container.assistant .message-bubble {
  background: #ffffff;
  color: #1a1a1a;
  border-bottom-left-radius: 4px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

.message-time {
  font-size: 11px;
  color: #999;
  margin-top: 4px;
  text-align: right;
}

.message-container.assistant .message-time {
  text-align: left;
  color: #999;
}

/* Source Info */
.source-info {
  font-size: 11px;
  color: #999;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #f0f0f0;
  display: flex;
  align-items: center;
  gap: 6px;
}

.mcp-info {
  margin-top: 8px;
  padding: 8px 10px;
  border-radius: 10px;
  background: #f8fafc;
  border: 1px dashed #cbd5f5;
  font-size: 12px;
  color: #475569;
}

.mcp-info strong {
  display: block;
  margin-bottom: 4px;
  color: #4f46e5;
}

.mcp-info details {
  margin-top: 6px;
}

/* Suggestion Buttons - ChatGPT é¢¨æ ¼ */
.suggestion-buttons {
  margin-top: 12px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.suggestion-button {
  background: #ffffff;
  border: 1.5px solid #e2e8f0;
  border-radius: 20px;
  padding: 10px 18px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  color: #4f46e5;
  font-weight: 500;
  white-space: nowrap;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.suggestion-button:hover {
  background: #f8fafc;
  border-color: #4f46e5;
  color: #4f46e5;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
}

/* Weather City Cards */
.weather-city-cards {
  margin-top: 12px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 8px;
}

.weather-city-card {
  background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  border: none;
  border-radius: 12px;
  padding: 14px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  color: white;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(79, 70, 229, 0.25);
}

.weather-city-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35);
}

/* Weather Display Card */
.weather-display-card {
  background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
  border-radius: 16px;
  padding: 18px;
  margin-top: 12px;
  color: white;
  box-shadow: 0 4px 16px rgba(6, 182, 212, 0.25);
}

.weather-display-card h3 {
  font-size: 16px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.weather-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 10px;
  margin-top: 10px;
}

.weather-info-item {
  background: rgba(255, 255, 255, 0.2);
  padding: 10px;
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.weather-info-item strong {
  display: block;
  font-size: 11px;
  opacity: 0.9;
  margin-bottom: 4px;
}

.weather-info-item span {
  font-size: 16px;
  font-weight: 600;
}

/* Input Area - LINE é¢¨æ ¼ */
footer {
  background: #ffffff;
  border-top: 1px solid #e2e8f0;
  padding: 14px 20px;
  box-shadow: 0 -2px 12px rgba(0,0,0,0.06);
}

.input-container {
  max-width: 100%;
  display: flex;
  align-items: flex-end;
  gap: 8px;
}

.input-wrapper {
  flex: 1;
  background: #f8fafc;
  border: 1.5px solid #e2e8f0;
  border-radius: 24px;
  padding: 12px 18px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.2s;
}

.input-wrapper:focus-within {
  background: #ffffff;
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

textarea {
  flex: 1;
  background: transparent;
  border: none;
  color: #333;
  font-size: 15px;
  font-family: inherit;
  resize: none;
  outline: none;
  min-height: 24px;
  max-height: 120px;
  line-height: 1.5;
  padding: 0;
}

textarea::placeholder {
  color: #999;
}

/* File Upload Button */
.file-upload-btn {
  background: transparent;
  border: none;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border-radius: 50%;
  transition: all 0.2s;
  color: #666;
  font-size: 20px;
  flex-shrink: 0;
}

.file-upload-btn:hover {
  background: #e2e8f0;
  color: #4f46e5;
}

.file-upload-btn::before {
  content: "ğŸ“";
}

#fileInput {
  display: none;
}

.send-button {
  background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  color: white;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
}

.send-button:hover:not(:disabled) {
  background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
  transform: scale(1.08);
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
}

.send-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.send-button::before {
  content: "â¤";
}

/* Thinking Animation */
.thinking {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #999;
  font-size: 14px;
  padding: 10px 14px;
}

.thinking-dots {
  display: inline-flex;
  gap: 4px;
}

.thinking-dots span {
  width: 6px;
  height: 6px;
  background: #999;
  border-radius: 50%;
  animation: thinking 1.4s infinite;
}

.thinking-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.thinking-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes thinking {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.5;
  }
  30% {
    transform: translateY(-6px);
    opacity: 1;
  }
}

/* Model Info Footer */
.model-footer {
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
  padding: 10px 20px;
  font-size: 11px;
  color: #64748b;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 500;
}

/* Responsive */
@media (max-width: 768px) {
  .message-bubble {
    max-width: 85%;
  }
  
  .weather-city-cards {
    grid-template-columns: repeat(3, 1fr);
  }
}
</style>
</head>

<body>
<header>
  <div class="header-left">
    <h1>AI æ™ºèƒ½é¡§å•</h1>
    <div class="header-subtitle">æ™ºæ…§æœå‹™ä¸­å¿ƒ</div>
  </div>
  <div class="header-right">
    <div id="engine" class="model-info">æº–å‚™ä¸­</div>
    <div class="header-avatar">
      <div class="avatar-3d">
        <div class="avatar-ring"></div>
        <div class="avatar-core"></div>
        <div class="avatar-face">
          <div class="avatar-eye"></div>
          <div class="avatar-eye"></div>
          <div class="avatar-mouth"></div>
        </div>
      </div>
    </div>
  </div>
</header>

<div id="log"></div>

<footer>
  <div class="input-container">
    <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()" title="ä¸Šå‚³æª”æ¡ˆ"></button>
    <input type="file" id="fileInput" multiple accept="*/*" onchange="handleFileUpload(event)">
    <div class="input-wrapper">
      <textarea id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." rows="1"></textarea>
    </div>
    <button id="sendBtn" class="send-button" onclick="send()" title="é€å‡º"></button>
  </div>
  <div class="model-footer">
    <span>ğŸ¤– <span id="modelName">æº–å‚™ä¸­</span></span>
    <span id="modelDetails"></span>
  </div>
</footer>

<script>
const log = document.getElementById("log");
const msg = document.getElementById("msg");
const engineEl = document.getElementById("engine");
const modelNameEl = document.getElementById("modelName");
const modelDetailsEl = document.getElementById("modelDetails");
const sendBtn = document.getElementById("sendBtn");
let sessionId = "";
let thinkingEl = null;
const API_BASE_URL = (window.API_BASE_URL || "").replace(/\/+$/, "");
const API_TOKEN = window.API_TOKEN || "é‡‘é‘°";

function apiUrl(path) {
  const base = `${API_BASE_URL}${path}`;
  const joiner = base.includes("?") ? "&" : "?";
  return API_TOKEN ? `${base}${joiner}token=${encodeURIComponent(API_TOKEN)}` : base;
}

function humanEngineLabel(engine, modelInfo) {
  if (modelInfo) {
    const provider = modelInfo.provider || "";
    const model = modelInfo.model || "";
    
    if (provider === "Hugging Face") {
      return `ğŸ¤— ${model.split("/").pop()}`;
    } else if (provider === "OpenAI") {
      return `ğŸ§  ${model}`;
    } else if (provider === "CWA") {
      return `â˜€ï¸ å¤©æ°£`;
    }
    return model;
  }
  
  const map = {
    "huggingface+rag": "ğŸ¤— Hugging Face",
    "chatgpt+rag": "ğŸ§  ChatGPT",
    "weather": "â˜€ï¸ å¤©æ°£",
    "error": "âš ï¸ éŒ¯èª¤"
  };
  return map[engine] || "æº–å‚™ä¸­";
}

function setEngine(engine, modelInfo) {
  const label = humanEngineLabel(engine, modelInfo);
  engineEl.textContent = label;
  modelNameEl.textContent = label;
  
  if (modelInfo) {
    modelDetailsEl.textContent = `${modelInfo.provider || ""} - ${modelInfo.api || ""}`;
  } else {
    modelDetailsEl.textContent = "";
  }
}

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function formatMessage(text) {
  if (!text) return "";
  
  // è½‰æ›ç‚ºå­—ä¸²
  let formatted = String(text);
  
  // çµ±ä¸€æ›è¡Œç¬¦
  formatted = formatted.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
  
  // è½‰ç¾© HTMLï¼ˆé€™æœƒä¿ç•™æ›è¡Œç¬¦ï¼‰
  formatted = escapeHtml(formatted);
  
  // å°‡æ›è¡Œè½‰ç‚º <br>
  formatted = formatted.replace(/\n/g, "<br>");
  
  return formatted;
}

function getCurrentTime() {
  const now = new Date();
  return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
}

function createAvatar(role) {
  const avatar = document.createElement("div");
  avatar.className = `avatar ${role}`;

  if (role === "assistant") {
    avatar.innerHTML = `
      <div class="avatar-3d">
        <div class="avatar-ring"></div>
        <div class="avatar-core"></div>
        <div class="avatar-face">
          <div class="avatar-eye"></div>
          <div class="avatar-eye"></div>
          <div class="avatar-mouth"></div>
        </div>
      </div>
    `;
  } else {
    avatar.innerHTML = `
      <div class="avatar-3d avatar-user-3d">
        <div class="avatar-ring"></div>
        <div class="avatar-core"></div>
        <div class="avatar-face"></div>
      </div>
    `;
  }

  return avatar;
}

function animateAssistantAvatar(avatar, content = "") {
  if (!avatar) return;
  if (!avatar.classList.contains("assistant")) return;
  avatar.classList.add("avatar-speaking");
  const duration = Math.min(2000, Math.max(800, content.length * 30));
  setTimeout(() => avatar.classList.remove("avatar-speaking"), duration);
}

function addMessage(role, content, modelInfo = null) {
  const container = document.createElement("div");
  container.className = `message-container ${role}`;
  
  const avatar = createAvatar(role);
  
  const messageWrapper = document.createElement("div");
  messageWrapper.style.display = "flex";
  messageWrapper.style.flexDirection = "column";
  messageWrapper.style.maxWidth = "70%";
  messageWrapper.style.flex = "0 0 auto";
  
  const bubble = document.createElement("div");
  bubble.className = "message-bubble";
  bubble.innerHTML = formatMessage(content);
  
  const time = document.createElement("div");
  time.className = "message-time";
  time.textContent = getCurrentTime();
  
  // å¦‚æœæ˜¯ bot å›è¦†ä¸”æœ‰æ¨¡å‹è³‡è¨Šï¼Œé¡¯ç¤ºä¾†æº
  if (role === "assistant" && modelInfo) {
    const sourceInfo = document.createElement("div");
    sourceInfo.className = "source-info";
    sourceInfo.innerHTML = `ğŸ“Œ ${modelInfo.provider || ""} - ${modelInfo.model || ""}`;
    bubble.appendChild(sourceInfo);
  }
  
  messageWrapper.appendChild(bubble);
  messageWrapper.appendChild(time);
  container.appendChild(avatar);
  container.appendChild(messageWrapper);
  log.appendChild(container);

  if (role === "assistant") {
    animateAssistantAvatar(avatar, content);
  }
  
  // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
  scrollToBottom();
  
  return bubble;
}

function scrollToBottom() {
  setTimeout(() => {
    log.scrollTop = log.scrollHeight;
  }, 100);
}

function addThinking() {
  const container = document.createElement("div");
  container.className = "message-container assistant";
  
  const avatar = createAvatar("assistant");
  avatar.classList.add("avatar-speaking");
  
  const messageWrapper = document.createElement("div");
  messageWrapper.style.display = "flex";
  messageWrapper.style.flexDirection = "column";
  
  const thinking = document.createElement("div");
  thinking.className = "thinking";
  thinking.innerHTML = `
    <span>æ­£åœ¨è¼¸å…¥</span>
    <div class="thinking-dots">
      <span></span><span></span><span></span>
    </div>
  `;
  
  messageWrapper.appendChild(thinking);
  container.appendChild(avatar);
  container.appendChild(messageWrapper);
  log.appendChild(container);
  scrollToBottom();
  
  return container;
}

function addSuggestionButtons(suggestions, bubble) {
  if (!suggestions || suggestions.length === 0) return;
  
  const buttonsContainer = document.createElement("div");
  buttonsContainer.className = "suggestion-buttons";
  
  suggestions.forEach(suggestion => {
    const button = document.createElement("button");
    button.className = "suggestion-button";
    button.textContent = suggestion;
    button.onclick = () => {
      buttonsContainer.remove();
      send(suggestion);
    };
    buttonsContainer.appendChild(button);
  });
  
  bubble.appendChild(buttonsContainer);
}

function addMcpInfo(bubble, mcp) {
  if (!mcp) return;
  const list = Array.isArray(mcp) ? mcp : [mcp];
  list.forEach(item => {
    if (!item) return;
    const box = document.createElement("div");
    box.className = "mcp-info";
    const sourceLabel = item.source === "accounting" ? "è¨˜å¸³ MCP" : "å¥åº· MCP";
    const toolLabel = item.tool ? `ï¼ˆ${item.tool}ï¼‰` : "";
    const content = item.content ? formatMessage(item.content) : "";
    box.innerHTML = `
      <strong>ğŸ”Œ ${sourceLabel} ${toolLabel}</strong>
      ${content ? `<details><summary>æŸ¥çœ‹è³‡æ–™</summary><div>${content}</div></details>` : ""}
    `;
    bubble.appendChild(box);
  });
}

function addWeatherCityCards(bubble) {
  const cities = ["å°åŒ—", "æ–°åŒ—", "æ¡ƒåœ’", "æ–°ç«¹", "å°ä¸­", "å°å—", "é«˜é›„", "èŠ±è“®", "è‡ºæ±"];
  
  const cardsContainer = document.createElement("div");
  cardsContainer.className = "weather-city-cards";
  
  cities.forEach(city => {
    const card = document.createElement("div");
    card.className = "weather-city-card";
    card.textContent = city;
    card.onclick = () => {
      cardsContainer.remove();
      send(`${city}å¤©æ°£`);
    };
    cardsContainer.appendChild(card);
  });
  
  bubble.appendChild(cardsContainer);
}

function addWeatherDisplay(weatherData) {
  const container = document.createElement("div");
  container.className = "message-container assistant";
  
  const avatar = document.createElement("div");
  avatar.className = "avatar assistant";
  avatar.textContent = "AI";
  
  const messageWrapper = document.createElement("div");
  messageWrapper.style.display = "flex";
  messageWrapper.style.flexDirection = "column";
  messageWrapper.style.maxWidth = "70%";
  
  const weatherCard = document.createElement("div");
  weatherCard.className = "weather-display-card";
  weatherCard.innerHTML = `
    <h3>â˜€ï¸ ${weatherData.city || "å¤©æ°£è³‡è¨Š"}</h3>
    <div class="weather-info">
      <div class="weather-info-item">
        <strong>ğŸŒ¡ æ°£æº«</strong>
        <span>${weatherData.temp || weatherData.temperature || "N/A"}</span>
      </div>
      <div class="weather-info-item">
        <strong>ğŸŒ§ é™é›¨æ©Ÿç‡</strong>
        <span>${weatherData.rain || "N/A"}%</span>
      </div>
    </div>
  `;
  
  const time = document.createElement("div");
  time.className = "message-time";
  time.textContent = getCurrentTime();
  
  messageWrapper.appendChild(weatherCard);
  messageWrapper.appendChild(time);
  container.appendChild(avatar);
  container.appendChild(messageWrapper);
  log.appendChild(container);
  scrollToBottom();
}

// è‡ªå‹•èª¿æ•´ textarea é«˜åº¦
function adjustTextareaHeight() {
  msg.style.height = "auto";
  msg.style.height = Math.min(msg.scrollHeight, 120) + "px";
}

msg.addEventListener("input", adjustTextareaHeight);

// æª”æ¡ˆä¸Šå‚³è™•ç†
async function handleFileUpload(event) {
  const files = event.target.files;
  if (files.length === 0) return;
  
  // é¡¯ç¤ºä¸Šå‚³ä¸­çš„è¨Šæ¯
  Array.from(files).forEach(file => {
    addMessage("user", `ğŸ“ ä¸Šå‚³ä¸­: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
  });
  
  // ä¸Šå‚³æª”æ¡ˆ
  try {
    const formData = new FormData();
    Array.from(files).forEach(file => {
      formData.append("files", file);
    });
    
    const response = await fetch(apiUrl("/api/upload"), {
      method: "POST",
      body: formData
    });
    
    const result = await response.json();
    
    if (result.ok) {
      // æ›´æ–°è¨Šæ¯ç‚ºæˆåŠŸ
      const lastUserMsg = log.querySelector(".message-container.user:last-child .message-bubble");
      if (lastUserMsg) {
        lastUserMsg.innerHTML = `ğŸ“ å·²ä¸Šå‚³: ${result.files.map(f => f.name).join(", ")}`;
      }
      
      // AI å›æ‡‰
      addMessage("assistant", `å·²æ”¶åˆ° ${result.files.length} å€‹æª”æ¡ˆï¼æˆ‘å¯ä»¥å¹«ä½ è™•ç†é€™äº›æª”æ¡ˆã€‚`, null);
    } else {
      addMessage("assistant", `ä¸Šå‚³å¤±æ•—ï¼š${result.error || "æœªçŸ¥éŒ¯èª¤"}`, null);
    }
  } catch (error) {
    addMessage("assistant", `ä¸Šå‚³å¤±æ•—ï¼š${error.message}`, null);
  }
  
  // é‡ç½® input
  event.target.value = "";
}

async function send(text) {
  const content = text || msg.value.trim();
  if (!content) return;
  
  msg.value = "";
  msg.style.height = "auto";
  
  // ç§»é™¤æ‰€æœ‰å»ºè­°æŒ‰éˆ•å’Œå¡ç‰‡
  document.querySelectorAll(".suggestion-buttons, .weather-city-cards").forEach(el => el.remove());
  
  // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
  addMessage("user", content);
  
  // é¡¯ç¤ºæ€è€ƒä¸­
  sendBtn.disabled = true;
  msg.disabled = true;
  thinkingEl = addThinking();
  
  let d = null;
  try {
    const r = await fetch(apiUrl("/api/chat"), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: content, sessionId })
    });
    d = await r.json();
  } catch (e) {
    d = {
      engine: "error",
      reply: "é€£ç·šå¤±æ•— ğŸ˜µ è«‹ç¢ºèª server æ˜¯å¦æ­£åœ¨åŸ·è¡Œã€‚",
      modelInfo: { model: "ç³»çµ±éŒ¯èª¤", api: "æœ¬åœ°", provider: "System" }
    };
  }
  
  // ç§»é™¤æ€è€ƒä¸­
  if (thinkingEl) {
    thinkingEl.remove();
    thinkingEl = null;
  }
  sendBtn.disabled = false;
  msg.disabled = false;
  
  sessionId = d.sessionId || sessionId;
  setEngine(d.engine, d.modelInfo);
  
  // é¡¯ç¤ºå›è¦†
  const bubble = addMessage("assistant", d.reply, d.modelInfo);
  
  // å¦‚æœéœ€è¦é¡¯ç¤ºåŸå¸‚é¸æ“‡å¡ç‰‡
  if (d.showCityCards || (d.engine === "weather" && (d.reply.includes("ç¸£å¸‚") || d.reply.includes("åŸå¸‚") || d.reply.includes("é¸æ“‡")))) {
    addWeatherCityCards(bubble);
  }
  
  // å¦‚æœæœ‰å»ºè­°å•é¡Œï¼Œé¡¯ç¤ºæŒ‰éˆ•ï¼ˆChatGPT é¢¨æ ¼ï¼‰
  if (d.suggestions && d.suggestions.length > 0) {
    addSuggestionButtons(d.suggestions, bubble);
  }

  if (d.mcp) {
    addMcpInfo(bubble, d.mcp);
  }
  
  // å¦‚æœæœ‰å¤©æ°£è³‡æ–™ï¼Œé¡¯ç¤ºå¤©æ°£å¡ç‰‡
  if (d.type === "weather-card" && d.data) {
    addWeatherDisplay(d.data);
  }
  
  msg.focus();
}

// éµç›¤äº‹ä»¶
msg.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

/**
 * Assistant Welcome Module
 * Handles initial greeting message and quick action suggestions
 */

document.addEventListener("DOMContentLoaded", initializeAssistantUI);

function initializeAssistantUI() {
  // Slight delay to ensure UI container is ready
  setTimeout(renderWelcomeMessage, 300);
}

function renderWelcomeMessage() {
  if (typeof addMessage !== "function" || typeof addSuggestionButtons !== "function") {
    console.warn("Chat UI functions not ready");
    return;
  }

  const WELCOME_CONFIG = {
    role: "assistant",
    message: `æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„ AI æ™ºèƒ½åŠ©ç†ã€‚

æˆ‘å¯ä»¥å”åŠ©æ‚¨é€²è¡Œä»¥ä¸‹æœå‹™ï¼š
â€¢ å¤©æ°£è³‡è¨ŠæŸ¥è©¢  
â€¢ é†«ç™‚å¥åº·è³‡æ–™æŸ¥è©¢ï¼ˆè¨ºæ–·ç¢¼ã€è—¥å“ã€æª¢é©—ï¼‰  
â€¢ å€‹äººè¨˜å¸³ç®¡ç†ï¼ˆæ”¯å‡ºç´€éŒ„ã€é¤˜é¡æŸ¥è©¢ã€äº¤æ˜“æ˜ç´°ï¼‰  
â€¢ ä¸€èˆ¬å•é¡Œè«®è©¢èˆ‡å°è©±å”åŠ©  

è«‹ç›´æ¥è¼¸å…¥æ‚¨çš„éœ€æ±‚ï¼Œæˆ–é»é¸ä¸‹æ–¹å¿«é€ŸæŒ‡ä»¤ã€‚`,
    suggestions: [
      "å¹«æˆ‘è¨˜å¸³ 350 åˆé¤",
      "æŸ¥å¸³æˆ¶é¤˜é¡",
      "ç³–å°¿ç—… ICD-10 è¨ºæ–·ç¢¼æ˜¯ä»€éº¼ï¼Ÿ",
      "ä»Šå¤©å°åŒ—å¤©æ°£å¦‚ä½•ï¼Ÿ"
    ]
  };

  try {
    const messageBubble = addMessage(WELCOME_CONFIG.role, WELCOME_CONFIG.message, null);
    addSuggestionButtons(WELCOME_CONFIG.suggestions, messageBubble);
  } catch (error) {
    console.error("Failed to render welcome UI:", error);
  }
}
</script>
</body>
</html>
