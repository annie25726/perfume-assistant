<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Perfume AI é¡§å•</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{font-family:system-ui,"Microsoft JhengHei";background:#FFF6CC;margin:0}
.wrap{max-width:960px;margin:30px auto;background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.1)}
header{padding:20px;font-size:22px;font-weight:700;color:#92400E}
#log{padding:20px;height:420px;overflow:auto}
.row{margin:12px 0;display:flex}
.me{justify-content:flex-end}
.bot{justify-content:flex-start}
.bubble{max-width:70%;padding:14px 16px;border-radius:14px;line-height:1.6}
.me .bubble{background:#F3F4F6}
.bot .bubble{background:#EAF6EC}

.weather-card{
  background:#fff;
  border-left:6px solid #FACC15;
  padding:14px 16px;
  border-radius:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.1);
  max-width:360px
}
.weather-card h4{margin:0 0 8px;color:#92400E}
.weather-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px}

.region-btns button{
  margin:6px 6px 0 0;
  padding:8px 14px;
  border-radius:10px;
  border:none;
  background:#FACC15;
  cursor:pointer;
  font-weight:600
}

.suggestion-cards{
  margin-top:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.suggestion-card{
  padding:12px 16px;
  background:#F9FAFB;
  border:1px solid #E5E7EB;
  border-radius:10px;
  cursor:pointer;
  transition:all 0.2s;
  font-size:14px;
  color:#374151;
}

.suggestion-card:hover{
  background:#F3F4F6;
  border-color:#D1D5DB;
  transform:translateX(4px);
}

.suggestion-card::before{
  content:"ğŸ’¡ ";
  margin-right:6px;
}

footer{padding:16px;border-top:1px solid #eee}
.engine-bar{font-size:13px;color:#6B7280;margin:0 0 8px;display:flex;align-items:center;gap:8px}
.engine-pill{background:#F3F4F6;color:#374151;border-radius:999px;padding:4px 10px;font-weight:700}
.input-row{display:flex;gap:10px}
textarea{flex:1;min-height:44px;max-height:120px;padding:10px;border-radius:10px;border:1px solid #ddd;resize:none;overflow-y:auto;font-family:inherit;line-height:1.5}
button.send{width:90px;border:none;border-radius:10px;background:#FACC15;font-weight:700}
button.send:disabled{opacity:.6;cursor:not-allowed}

/* Thinking dots */
.dots::after{content:"";display:inline-block;width:14px;animation:dots 1.2s infinite steps(4)}
@keyframes dots{0%{content:""}25%{content:"."}50%{content:".."}75%{content:"..."}100%{content:""}}
</style>
</head>

<body>
<div class="wrap">
<header>Perfume AI é¡§å•</header>
<div id="log"></div>
<footer>
  <div class="engine-bar">
    <span>ğŸ¤– ç›®å‰ä½¿ç”¨ï¼š</span>
    <span id="engine" class="engine-pill">æº–å‚™ä¸­</span>
  </div>
  <div class="input-row">
    <textarea id="msg" placeholder="è¼¸å…¥å•é¡Œâ€¦"></textarea>
    <button id="sendBtn" class="send" onclick="send()">é€å‡º</button>
  </div>
</footer>
</div>

<script>
const log=document.getElementById("log");
const msg=document.getElementById("msg");
const engineEl=document.getElementById("engine");
const sendBtn=document.getElementById("sendBtn");
let sessionId="";
let thinkingEl=null;

function humanEngineLabel(engine, modelInfo){
  if (modelInfo) {
    const provider = modelInfo.provider || "";
    const model = modelInfo.model || "";
    const api = modelInfo.api || "";
    
    if (provider === "Hugging Face") {
      return `ğŸ¤— ${model}`;
    } else if (provider === "OpenAI") {
      return `ğŸ§  ${model}`;
    } else if (provider === "CWA") {
      return `â˜€ï¸ ${api}`;
    }
    return `${api} - ${model}`;
  }
  
  const map={
    "L1_RAG":"âš¡ æœ¬åœ° Ollama + RAG",
    "L2":"ğŸ§  ChatGPTï¼ˆé«˜å“è³ªï¼‰",
    "L2_RAG":"ğŸ§  ChatGPT + RAG",
    "MCP_DIRECT":"ğŸ“Œ MCPï¼ˆç›´æ¥å›ç­”ï¼‰",
    "TOOL_WEATHER":"â˜€ï¸ å¤©æ°£å·¥å…·",
    "weather":"â˜€ï¸ å¤©æ°£å·¥å…·",
    "huggingface+rag":"ğŸ¤— Hugging Face",
    "chatgpt+rag":"ğŸ§  ChatGPT",
    "error":"âš ï¸ ç³»çµ±éŒ¯èª¤"
  };
  return map[engine] || engine || "æº–å‚™ä¸­";
}

function setEngine(engine, modelInfo){
  engineEl.textContent=humanEngineLabel(engine, modelInfo);
}

function add(role, html, modelInfo){
  const row=document.createElement("div");
  row.className="row "+(role==="user"?"me":"bot");
  const bubble=document.createElement("div");
  bubble.className="bubble";
  
  // å¦‚æœæ˜¯ bot å›è¦†ä¸”æœ‰æ¨¡å‹è³‡è¨Šï¼Œé¡¯ç¤ºä¾†æº
  if (role === "bot" && modelInfo) {
    const sourceInfo = document.createElement("div");
    sourceInfo.style.fontSize = "11px";
    sourceInfo.style.color = "#6B7280";
    sourceInfo.style.marginTop = "8px";
    sourceInfo.style.paddingTop = "8px";
    sourceInfo.style.borderTop = "1px solid #E5E7EB";
    sourceInfo.innerHTML = `ğŸ“Œ ä¾†æºï¼š${modelInfo.provider || ""} - ${modelInfo.model || ""} (${modelInfo.api || ""})`;
    bubble.innerHTML = html;
    bubble.appendChild(sourceInfo);
  } else {
    bubble.innerHTML = html;
  }
  
  row.appendChild(bubble);
  log.appendChild(row);
  log.scrollTop=log.scrollHeight;
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function addDebug(debug){
  const row=document.createElement("div");
  row.className="row bot";
  const bubble=document.createElement("div");
  bubble.className="bubble";
  bubble.style.background="#F3F4F6";
  bubble.style.color="#111827";
  bubble.style.border="1px dashed #D1D5DB";

  const pretty = escapeHtml(JSON.stringify(debug, null, 2));
  bubble.innerHTML = `
    <details class="debug">
      <summary>Debugï¼ˆå±•é–‹/æ”¶åˆï¼‰</summary>
      <pre style="white-space:pre-wrap;margin:8px 0 0">${pretty}</pre>
    </details>
  `;
  row.appendChild(bubble);
  log.appendChild(row);
  log.scrollTop=log.scrollHeight;
}


function addWeather(w){
  const row=document.createElement("div");
  row.className="row bot";
  const card=document.createElement("div");
  card.className="weather-card";
  card.innerHTML=`
    <h4>ğŸ“ ${w.city || w.location || ""}</h4>
    <div class="weather-grid">
      <div>â˜ï¸ å¤©æ°£ï¼š${w.weather || w.desc || "-"}</div>
      <div>ğŸŒ¡ æº«åº¦ï¼š${(w.minTemp && w.maxTemp) ? `${w.minTemp}ï½${w.maxTemp}Â°C` : (w.temp || "-")}</div>
      <div>ğŸŒ§ é™é›¨ï¼š${w.rain || "-"}%</div>
    </div>`;
  row.appendChild(card);
  log.appendChild(row);
  log.scrollTop=log.scrollHeight;
}

function regionButtons(options){
  const opts = options && options.length ? options : ["åŒ—éƒ¨","ä¸­éƒ¨","å—éƒ¨","æ±éƒ¨","å…¨å°"];
  return `
  <div class="region-btns">
    ${opts.map(o => `<button onclick="quick('${o}')">${o}</button>`).join("")}
  </div>`;
}

// è‡ªå‹•èª¿æ•´ textarea é«˜åº¦
function adjustTextareaHeight() {
  msg.style.height = "auto";
  msg.style.height = Math.min(msg.scrollHeight, 120) + "px";
}

msg.addEventListener("input", adjustTextareaHeight);

async function send(text){
  const content=text||msg.value.trim();
  if(!content) return;
  msg.value="";
  msg.style.height = "44px"; // é‡ç½®é«˜åº¦
  
  // ç§»é™¤æ‰€æœ‰å»ºè­°å¡ç‰‡
  document.querySelectorAll(".suggestion-cards").forEach(el => el.remove());
  
  add("user",content);

  // UI: æ€è€ƒä¸­ï¼ˆåƒ ChatGPT ä¸€æ¨£ï¼‰
  sendBtn.disabled=true;
  msg.disabled=true;
  thinkingEl = document.createElement("div");
  thinkingEl.className = "row bot";
  thinkingEl.innerHTML = `<div class="bubble">ğŸ¤” AI æ­£åœ¨æ€è€ƒä¸­<span class="dots"></span></div>`;
  log.appendChild(thinkingEl);
  log.scrollTop=log.scrollHeight;

  let d=null;
  try{
    const r=await fetch("/api/chat",{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:content,sessionId})
    });
    d=await r.json();
  }catch(e){
    d={ 
      engine:"error", 
      reply:"é€£ç·šå¤±æ•— ğŸ˜µ è«‹ç¢ºèª server æ˜¯å¦æ­£åœ¨åŸ·è¡Œã€‚",
      modelInfo: { model: "ç³»çµ±éŒ¯èª¤", api: "æœ¬åœ°", provider: "System" }
    };
  }

  // UI: çµæŸæ€è€ƒ
  if(thinkingEl){ thinkingEl.remove(); thinkingEl=null; }
  sendBtn.disabled=false;
  msg.disabled=false;

  sessionId=d.sessionId||sessionId;

  // é¡¯ç¤ºé€™æ¬¡èµ°å“ªå€‹å¹³å°
  setEngine(d.engine, d.modelInfo);

  // å›è¦†æ¸²æŸ“
  let replyHtml = d.reply;
  if(d.ui?.needLocation){
    replyHtml += regionButtons(d.ui?.options);
  }
  
  // å¦‚æœæœ‰å»ºè­°å•é¡Œï¼ŒåŠ å…¥å¡ç‰‡
  if(d.suggestions && d.suggestions.length > 0){
    replyHtml += `<div class="suggestion-cards">${d.suggestions.map(s => {
      const escaped = escapeHtml(s).replace(/'/g, "&#039;");
      return `<div class="suggestion-card" onclick="sendSuggestion('${escaped}')">${escapeHtml(s)}</div>`;
    }).join("")}</div>`;
  }
  
  add("assistant", replyHtml, d.modelInfo);


  // Debugï¼ˆè‹¥å¾Œç«¯æœ‰å›å‚³ï¼‰
  if(d.debug){
    addDebug(d.debug);
  }

  // å¤©æ°£å¡ç‰‡
  if(d.type==="weather-card" && d.data){
    addWeather(d.data);
  }else if((d.type==="taiwan-summary" || d.type==="weather-region") && d.data){
    // å€åŸŸæ‘˜è¦ï¼šè‹¥æœ‰é¸æ“‡å€åŸŸå°±é¡¯ç¤ºä¸€ç­†ï¼›å¦å‰‡é¡¯ç¤ºå››å€
    const sel=d.ui?.selectedRegion;
    if(sel && d.data[sel]){
      addWeather({ city:d.data[sel].city, weather:d.data[sel].weather, temp:d.data[sel].temp, rain:d.data[sel].rain });
    }else{
      ["åŒ—éƒ¨","ä¸­éƒ¨","å—éƒ¨","æ±éƒ¨"].forEach(r=>{
        if(d.data[r]) addWeather({ city:d.data[r].city, weather:d.data[r].weather, temp:d.data[r].temp, rain:d.data[r].rain });
      });
    }
  }

  msg.focus();
}

function quick(v){ send(v); }

function sendSuggestion(text){
  // ç§»é™¤æ‰€æœ‰å»ºè­°å¡ç‰‡
  document.querySelectorAll(".suggestion-cards").forEach(el => el.remove());
  send(text);
}

msg.addEventListener("keydown",e=>{
  // Shift+Enter æˆ–æŒ‰éˆ•é€å‡ºï¼ŒEnter æ›è¡Œ
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
  // Enter å–®ç¨æŒ‰ä¸‹æ™‚å…è¨±æ›è¡Œï¼ˆé è¨­è¡Œç‚ºï¼‰
});

// é¦–æ¬¡è¼‰å…¥æ™‚é¡¯ç¤ºæ­¡è¿è¨Šæ¯å’Œå»ºè­°å•é¡Œ
window.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    add("assistant", "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„èŠå¤©å¤§å¸«ï¼Œä»€éº¼éƒ½å¯ä»¥èŠï¼ğŸ˜Š<br><br>ä½ å¯ä»¥å•æˆ‘å¤©æ°£ã€èŠå¤©ã€å­¸ç¿’ã€å‰µæ„ç™¼æƒ³ç­‰å„ç¨®è©±é¡Œã€‚", null);
    const welcomeSuggestions = [
      "ä»Šå¤©å°åŒ—å¤©æ°£å¦‚ä½•ï¼Ÿ",
      "æ¨è–¦ä¸€äº›é©åˆé›¨å¤©çš„å¿ƒæƒ…èª¿é©æ–¹æ³•",
      "èŠèŠæœ€è¿‘çš„ç”Ÿæ´»",
      "æœ‰ä»€éº¼æœ‰è¶£çš„è©±é¡Œå¯ä»¥èŠï¼Ÿ"
    ];
    const suggestionsHtml = `<div class="suggestion-cards">${welcomeSuggestions.map(s => {
      const escaped = escapeHtml(s).replace(/'/g, "&#039;");
      return `<div class="suggestion-card" onclick="sendSuggestion('${escaped}')">${escapeHtml(s)}</div>`;
    }).join("")}</div>`;
    const lastBotMsg = document.querySelector(".row.bot:last-child .bubble");
    if (lastBotMsg) {
      lastBotMsg.innerHTML += suggestionsHtml;
    }
  }, 500);
});
</script>
</body>
</html>
