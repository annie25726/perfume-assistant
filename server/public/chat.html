<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Perfume AI é¡§å•</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Roboto, sans-serif;
  background: #343541;
  color: #ececf1;
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Header */
header {
  background: #202123;
  padding: 12px 16px;
  border-bottom: 1px solid #4d4d4f;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

header h1 {
  font-size: 18px;
  font-weight: 600;
  color: #ececf1;
}

.engine-indicator {
  font-size: 12px;
  color: #8e8ea0;
  display: flex;
  align-items: center;
  gap: 6px;
}

.engine-pill {
  background: #40414f;
  color: #ececf1;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 500;
}

/* Chat Container */
#log {
  flex: 1;
  overflow-y: auto;
  padding: 24px 0;
  background: #343541;
}

#log::-webkit-scrollbar {
  width: 8px;
}

#log::-webkit-scrollbar-track {
  background: #343541;
}

#log::-webkit-scrollbar-thumb {
  background: #565869;
  border-radius: 4px;
}

#log::-webkit-scrollbar-thumb:hover {
  background: #6e6e80;
}

/* Message Rows */
.message-row {
  display: flex;
  padding: 16px 0;
  gap: 16px;
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message-row.user {
  background: #343541;
}

.message-row.assistant {
  background: #444654;
}

.message-row.user .message-content {
  margin-left: auto;
  max-width: 85%;
}

.message-row.assistant .message-content {
  max-width: 85%;
}

/* Avatar */
.avatar {
  width: 32px;
  height: 32px;
  border-radius: 4px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 600;
}

.avatar.user {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.avatar.assistant {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
}

/* Message Bubble */
.message-bubble {
  background: transparent;
  padding: 0;
  line-height: 1.75;
  font-size: 16px;
  color: #ececf1;
  word-wrap: break-word;
}

.message-row.user .message-bubble {
  background: #10a37f;
  padding: 12px 16px;
  border-radius: 18px 18px 4px 18px;
  color: white;
  max-width: 100%;
}

.message-row.assistant .message-bubble {
  padding: 0;
}

.message-bubble p {
  margin: 0 0 12px 0;
}

.message-bubble p:last-child {
  margin-bottom: 0;
}

/* Source Info */
.source-info {
  font-size: 11px;
  color: #8e8ea0;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #4d4d4f;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Suggestion Cards */
.suggestion-cards {
  margin-top: 16px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px;
}

.suggestion-card {
  background: #40414f;
  border: 1px solid #565869;
  border-radius: 12px;
  padding: 12px 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  color: #ececf1;
  display: flex;
  align-items: center;
  gap: 8px;
}

.suggestion-card:hover {
  background: #565869;
  border-color: #8e8ea0;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.suggestion-card::before {
  content: "ğŸ’¡";
  font-size: 16px;
}

/* Weather City Selection Cards */
.weather-city-cards {
  margin-top: 16px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
}

.weather-city-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
  color: white;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.weather-city-card:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

.weather-city-card::before {
  content: "ğŸ“";
  display: block;
  font-size: 24px;
  margin-bottom: 8px;
}

/* Weather Display Card */
.weather-display-card {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  border-radius: 16px;
  padding: 20px;
  margin-top: 16px;
  color: white;
  box-shadow: 0 4px 16px rgba(245, 87, 108, 0.3);
}

.weather-display-card h3 {
  font-size: 18px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.weather-display-card h3::before {
  content: "â˜€ï¸";
  font-size: 24px;
}

.weather-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  margin-top: 12px;
}

.weather-info-item {
  background: rgba(255, 255, 255, 0.2);
  padding: 12px;
  border-radius: 10px;
  backdrop-filter: blur(10px);
}

.weather-info-item strong {
  display: block;
  font-size: 12px;
  opacity: 0.9;
  margin-bottom: 4px;
}

.weather-info-item span {
  font-size: 18px;
  font-weight: 600;
}

/* Region Buttons */
.region-buttons {
  margin-top: 16px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.region-button {
  background: #40414f;
  border: 1px solid #565869;
  border-radius: 12px;
  padding: 10px 18px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  color: #ececf1;
  font-weight: 500;
}

.region-button:hover {
  background: #565869;
  border-color: #8e8ea0;
  transform: translateY(-2px);
}

/* Input Area */
footer {
  background: #202123;
  border-top: 1px solid #4d4d4f;
  padding: 16px;
}

.input-container {
  max-width: 768px;
  margin: 0 auto;
  position: relative;
}

.input-wrapper {
  background: #40414f;
  border: 1px solid #565869;
  border-radius: 24px;
  padding: 12px 16px;
  display: flex;
  align-items: flex-end;
  gap: 12px;
  transition: border-color 0.2s;
}

.input-wrapper:focus-within {
  border-color: #8e8ea0;
}

textarea {
  flex: 1;
  background: transparent;
  border: none;
  color: #ececf1;
  font-size: 16px;
  font-family: inherit;
  resize: none;
  outline: none;
  min-height: 24px;
  max-height: 200px;
  line-height: 1.5;
  padding: 0;
}

textarea::placeholder {
  color: #8e8ea0;
}

.send-button {
  background: #10a37f;
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  color: white;
  font-size: 16px;
}

.send-button:hover:not(:disabled) {
  background: #0d8f6e;
  transform: scale(1.05);
}

.send-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.send-button::before {
  content: "â¤";
}

/* Thinking Animation */
.thinking {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #8e8ea0;
  font-size: 14px;
}

.thinking-dots {
  display: inline-flex;
  gap: 4px;
}

.thinking-dots span {
  width: 6px;
  height: 6px;
  background: #8e8ea0;
  border-radius: 50%;
  animation: thinking 1.4s infinite;
}

.thinking-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.thinking-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes thinking {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.5;
  }
  30% {
    transform: translateY(-8px);
    opacity: 1;
  }
}

/* Debug Info */
.debug-info {
  background: #2d2d2d;
  border: 1px dashed #565869;
  border-radius: 8px;
  padding: 12px;
  margin-top: 12px;
  font-size: 12px;
  color: #8e8ea0;
}

/* Responsive */
@media (max-width: 768px) {
  .message-row .message-content {
    max-width: 90% !important;
  }
  
  .suggestion-cards,
  .weather-city-cards {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>
<header>
  <h1>ğŸ¤– Perfume AI é¡§å•</h1>
  <div class="engine-indicator">
    <span>ä½¿ç”¨ï¼š</span>
    <span id="engine" class="engine-pill">æº–å‚™ä¸­</span>
  </div>
</header>

<div id="log"></div>

<footer>
  <div class="input-container">
    <div class="input-wrapper">
      <textarea id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." rows="1"></textarea>
      <button id="sendBtn" class="send-button" onclick="send()" title="é€å‡º (Enter)"></button>
    </div>
  </div>
</footer>

<script>
const log = document.getElementById("log");
const msg = document.getElementById("msg");
const engineEl = document.getElementById("engine");
const sendBtn = document.getElementById("sendBtn");
let sessionId = "";
let thinkingEl = null;

function humanEngineLabel(engine, modelInfo) {
  if (modelInfo) {
    const provider = modelInfo.provider || "";
    const model = modelInfo.model || "";
    
    if (provider === "Hugging Face") {
      return `ğŸ¤— ${model.split("/").pop()}`;
    } else if (provider === "OpenAI") {
      return `ğŸ§  ${model}`;
    } else if (provider === "CWA") {
      return `â˜€ï¸ å¤©æ°£ API`;
    }
    return `${model}`;
  }
  
  const map = {
    "huggingface+rag": "ğŸ¤— Hugging Face",
    "chatgpt+rag": "ğŸ§  ChatGPT",
    "weather": "â˜€ï¸ å¤©æ°£å·¥å…·",
    "error": "âš ï¸ éŒ¯èª¤"
  };
  return map[engine] || "æº–å‚™ä¸­";
}

function setEngine(engine, modelInfo) {
  engineEl.textContent = humanEngineLabel(engine, modelInfo);
}

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function formatMessage(text) {
  // å°‡æ›è¡Œè½‰æ›ç‚º <br>
  return escapeHtml(text).replace(/\n/g, "<br>");
}

function addMessage(role, content, modelInfo = null) {
  const row = document.createElement("div");
  row.className = `message-row ${role}`;
  
  const avatar = document.createElement("div");
  avatar.className = `avatar ${role}`;
  avatar.textContent = role === "user" ? "ä½ " : "AI";
  
  const messageContent = document.createElement("div");
  messageContent.className = "message-content";
  
  const bubble = document.createElement("div");
  bubble.className = "message-bubble";
  bubble.innerHTML = formatMessage(content);
  
  // å¦‚æœæ˜¯ bot å›è¦†ä¸”æœ‰æ¨¡å‹è³‡è¨Šï¼Œé¡¯ç¤ºä¾†æº
  if (role === "assistant" && modelInfo) {
    const sourceInfo = document.createElement("div");
    sourceInfo.className = "source-info";
    sourceInfo.innerHTML = `ğŸ“Œ ${modelInfo.provider || ""} - ${modelInfo.model || ""}`;
    bubble.appendChild(sourceInfo);
  }
  
  messageContent.appendChild(bubble);
  row.appendChild(avatar);
  row.appendChild(messageContent);
  log.appendChild(row);
  log.scrollTop = log.scrollHeight;
  
  return bubble;
}

function addThinking() {
  const row = document.createElement("div");
  row.className = "message-row assistant";
  
  const avatar = document.createElement("div");
  avatar.className = "avatar assistant";
  avatar.textContent = "AI";
  
  const messageContent = document.createElement("div");
  messageContent.className = "message-content";
  
  const thinking = document.createElement("div");
  thinking.className = "thinking";
  thinking.innerHTML = `
    <span>æ€è€ƒä¸­</span>
    <div class="thinking-dots">
      <span></span><span></span><span></span>
    </div>
  `;
  
  messageContent.appendChild(thinking);
  row.appendChild(avatar);
  row.appendChild(messageContent);
  log.appendChild(row);
  log.scrollTop = log.scrollHeight;
  
  return row;
}

function addSuggestionCards(suggestions, bubble) {
  if (!suggestions || suggestions.length === 0) return;
  
  const cardsContainer = document.createElement("div");
  cardsContainer.className = "suggestion-cards";
  
  suggestions.forEach(suggestion => {
    const card = document.createElement("div");
    card.className = "suggestion-card";
    card.textContent = suggestion;
    card.onclick = () => {
      cardsContainer.remove();
      send(suggestion);
    };
    cardsContainer.appendChild(card);
  });
  
  bubble.appendChild(cardsContainer);
}

function addWeatherCityCards(bubble) {
  const cities = ["å°åŒ—", "æ–°åŒ—", "æ¡ƒåœ’", "æ–°ç«¹", "å°ä¸­", "å°å—", "é«˜é›„", "èŠ±è“®", "å°æ±"];
  
  const cardsContainer = document.createElement("div");
  cardsContainer.className = "weather-city-cards";
  
  cities.forEach(city => {
    const card = document.createElement("div");
    card.className = "weather-city-card";
    card.textContent = city;
    card.onclick = () => {
      cardsContainer.remove();
      send(`${city}å¤©æ°£`);
    };
    cardsContainer.appendChild(card);
  });
  
  bubble.appendChild(cardsContainer);
}

function addWeatherDisplay(weatherData) {
  const row = document.createElement("div");
  row.className = "message-row assistant";
  
  const avatar = document.createElement("div");
  avatar.className = "avatar assistant";
  avatar.textContent = "AI";
  
  const messageContent = document.createElement("div");
  messageContent.className = "message-content";
  
  const weatherCard = document.createElement("div");
  weatherCard.className = "weather-display-card";
  weatherCard.innerHTML = `
    <h3>${weatherData.city || "å¤©æ°£è³‡è¨Š"}</h3>
    <div class="weather-info">
      <div class="weather-info-item">
        <strong>ğŸŒ¡ æ°£æº«</strong>
        <span>${weatherData.temp || weatherData.temperature || "N/A"}</span>
      </div>
      <div class="weather-info-item">
        <strong>ğŸŒ§ é™é›¨æ©Ÿç‡</strong>
        <span>${weatherData.rain || "N/A"}%</span>
      </div>
    </div>
  `;
  
  messageContent.appendChild(weatherCard);
  row.appendChild(avatar);
  row.appendChild(messageContent);
  log.appendChild(row);
  log.scrollTop = log.scrollHeight;
}

// è‡ªå‹•èª¿æ•´ textarea é«˜åº¦
function adjustTextareaHeight() {
  msg.style.height = "auto";
  msg.style.height = Math.min(msg.scrollHeight, 200) + "px";
}

msg.addEventListener("input", adjustTextareaHeight);

async function send(text) {
  const content = text || msg.value.trim();
  if (!content) return;
  
  msg.value = "";
  msg.style.height = "auto";
  
  // ç§»é™¤æ‰€æœ‰å»ºè­°å¡ç‰‡
  document.querySelectorAll(".suggestion-cards, .weather-city-cards").forEach(el => el.remove());
  
  // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
  addMessage("user", content);
  
  // é¡¯ç¤ºæ€è€ƒä¸­
  sendBtn.disabled = true;
  msg.disabled = true;
  thinkingEl = addThinking();
  
  let d = null;
  try {
    const r = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: content, sessionId })
    });
    d = await r.json();
  } catch (e) {
    d = {
      engine: "error",
      reply: "é€£ç·šå¤±æ•— ğŸ˜µ è«‹ç¢ºèª server æ˜¯å¦æ­£åœ¨åŸ·è¡Œã€‚",
      modelInfo: { model: "ç³»çµ±éŒ¯èª¤", api: "æœ¬åœ°", provider: "System" }
    };
  }
  
  // ç§»é™¤æ€è€ƒä¸­
  if (thinkingEl) {
    thinkingEl.remove();
    thinkingEl = null;
  }
  sendBtn.disabled = false;
  msg.disabled = false;
  
  sessionId = d.sessionId || sessionId;
  setEngine(d.engine, d.modelInfo);
  
  // é¡¯ç¤ºå›è¦†
  const bubble = addMessage("assistant", d.reply, d.modelInfo);
  
  // å¦‚æœéœ€è¦é¡¯ç¤ºåŸå¸‚é¸æ“‡å¡ç‰‡
  if (d.showCityCards || (d.engine === "weather" && (d.reply.includes("ç¸£å¸‚") || d.reply.includes("åŸå¸‚") || d.reply.includes("é¸æ“‡")))) {
    addWeatherCityCards(bubble);
  }
  
  // å¦‚æœæœ‰å»ºè­°å•é¡Œï¼Œé¡¯ç¤ºå¡ç‰‡
  if (d.suggestions && d.suggestions.length > 0) {
    addSuggestionCards(d.suggestions, bubble);
  }
  
  // å¦‚æœæœ‰å¤©æ°£è³‡æ–™ï¼Œé¡¯ç¤ºå¤©æ°£å¡ç‰‡
  if (d.type === "weather-card" && d.data) {
    addWeatherDisplay(d.data);
  }
  
  msg.focus();
}

// éµç›¤äº‹ä»¶
msg.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

// é¦–æ¬¡è¼‰å…¥
window.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    const bubble = addMessage(
      "assistant",
      "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI èŠå¤©åŠ©æ‰‹ ğŸ¤–\n\næˆ‘å¯ä»¥å¹«ä½ ï¼š\nâ€¢ æŸ¥è©¢å¤©æ°£è³‡è¨Š\nâ€¢ èŠå¤©å°è©±\nâ€¢ å›ç­”å„ç¨®å•é¡Œ\n\næœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«ä½ çš„å—ï¼Ÿ",
      null
    );
    
    const welcomeSuggestions = [
      "ä»Šå¤©å°åŒ—å¤©æ°£å¦‚ä½•ï¼Ÿ",
      "æ¨è–¦ä¸€äº›æ”¾é¬†å¿ƒæƒ…çš„æ–¹æ³•",
      "èŠèŠæœ€è¿‘çš„ç”Ÿæ´»",
      "æœ‰ä»€éº¼æœ‰è¶£çš„è©±é¡Œï¼Ÿ"
    ];
    
    addSuggestionCards(welcomeSuggestions, bubble);
  }, 300);
});
</script>
</body>
</html>
